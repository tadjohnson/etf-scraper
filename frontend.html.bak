<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF Dividend Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-8">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                        üìà ETF Dividend Declaration Tracker
                    </h1>
                    <p class="text-gray-600 mt-2">
                        Monitor dividend declarations with 12-month trend analysis
                    </p>
                </div>
                <div class="flex gap-3">
                    <button 
                        id="scrapeBtn"
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span id="scrapeIcon">üîÑ</span>
                        <span id="scrapeText">Run Scraper</span>
                    </button>
                    <button 
                        id="refreshBtn"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span id="refreshIcon">üîÑ</span>
                        <span id="refreshText">Refresh Data</span>
                    </button>
                </div>
            </div>

            <div id="lastUpdate" class="flex items-center gap-2 text-sm text-gray-600 mb-4 hidden">
                üìÖ Last updated: <span id="updateTime"></span>
            </div>

            <div id="errorAlert" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 hidden">
                <p class="font-semibold">Error</p>
                <p class="text-sm" id="errorMessage"></p>
            </div>

            <div id="noDataAlert" class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg mb-6 hidden">
                <p class="text-sm">
                    <strong>No data available.</strong> Click "Run Scraper" to fetch the latest dividend declarations.
                </p>
            </div>

            <div id="successAlert" class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-4 hidden">
                <p class="font-semibold">‚úì Success</p>
                <p class="text-sm" id="successMessage"></p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-xl overflow-hidden mb-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-indigo-600 text-white">
                        <tr>
                            <th class="px-6 py-4 text-left font-semibold">Ticker</th>
                            <th class="px-6 py-4 text-left font-semibold">ETF Name</th>
                            <th class="px-6 py-4 text-left font-semibold">Frequency</th>
                            <th class="px-6 py-4 text-left font-semibold">Latest Dividend</th>
                            <th class="px-6 py-4 text-left font-semibold">12-Month Trend</th>
                            <th class="px-6 py-4 text-left font-semibold">Ex-Date</th>
                            <th class="px-6 py-4 text-left font-semibold">12M Total</th>
                            <th class="px-6 py-4 text-left font-semibold">Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                <div class="text-6xl mb-4">üíµ</div>
                                <p>No dividend data available</p>
                                <p class="text-sm mt-2">Click "Refresh Data" to load data</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="historyCharts" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"></div>

        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h3 class="font-semibold text-blue-900 mb-2">API Connection:</h3>
            <p class="text-sm text-blue-800">
                Connected to: <code class="bg-blue-100 px-2 py-1 rounded" id="apiUrl">http://localhost:5001</code>
                <span id="apiStatus" class="ml-2"></span>
            </p>
        </div>
    </div>

    <script>
        var API_URL = 'http://localhost:5001';
        var historyData = {};
        
        var scrapeBtn = document.getElementById('scrapeBtn');
        var refreshBtn = document.getElementById('refreshBtn');
        var scrapeIcon = document.getElementById('scrapeIcon');
        var scrapeText = document.getElementById('scrapeText');
        var refreshIcon = document.getElementById('refreshIcon');
        var refreshText = document.getElementById('refreshText');
        var tableBody = document.getElementById('tableBody');
        var errorAlert = document.getElementById('errorAlert');
        var errorMessage = document.getElementById('errorMessage');
        var noDataAlert = document.getElementById('noDataAlert');
        var successAlert = document.getElementById('successAlert');
        var successMessage = document.getElementById('successMessage');
        var lastUpdate = document.getElementById('lastUpdate');
        var updateTime = document.getElementById('updateTime');
        var apiStatus = document.getElementById('apiStatus');
        var historyCharts = document.getElementById('historyCharts');

        function createSparkline(data, width, height) {
            if (!data || data.length === 0) {
                return '<span class="text-gray-400">No data</span>';
            }

            var amounts = data.map(function(d) { return d.amount; }).reverse();
            var max = Math.max.apply(null, amounts);
            var min = Math.min.apply(null, amounts);
            var range = max - min || 1;

            var barWidth = width / amounts.length;
            var bars = amounts.map(function(val, i) {
                var x = i * barWidth;
                var barHeight = ((val - min) / range * height) || 1;
                var y = height - barHeight;
                return '<rect x="' + x + '" y="' + y + '" width="' + (barWidth * 0.8) + '" height="' + barHeight + '" />';
            }).join('');

            var recent = amounts.slice(-3).reduce(function(a, b) { return a + b; }, 0) / 3;
            var older = amounts.slice(-6, -3).reduce(function(a, b) { return a + b; }, 0) / 3;
            var color = recent > older ? '#10b981' : recent < older ? '#ef4444' : '#6b7280';

            return '<svg width="' + width + '" height="' + height + '" class="inline-block"><g fill="' + color + '">' + bars + '</g></svg>';
        }

        function createDetailedChart(ticker, data, stats) {
            if (!data || data.length === 0) {
                return '';
            }

            var trendIcon = stats.trend === 'increasing' ? 'üìà' : stats.trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';
            var trendColor = stats.trend === 'increasing' ? 'text-green-600' : stats.trend === 'decreasing' ? 'text-red-600' : 'text-gray-600';

            var sparkline = createSparkline(data.slice(0, 12), 280, 60);
            
            var sortedData = data.slice().sort(function(a, b) {
                return new Date(b.ex_date) - new Date(a.ex_date);
            });
            
            var recentDivs = sortedData.slice(0, 12).map(function(div) {
                return '<div class="flex justify-between text-xs"><span class="text-gray-600">' + div.ex_date + '</span><span class="font-semibold">$' + div.amount.toFixed(5) + '</span></div>';
            }).join('');

            var html = '<div class="bg-white rounded-lg shadow-lg p-6">';
            html += '<div class="flex items-center justify-between mb-4">';
            html += '<h3 class="text-lg font-bold text-gray-800">' + ticker + '</h3>';
            html += '<span class="' + trendColor + ' text-2xl">' + trendIcon + '</span>';
            html += '</div>';
            html += '<div class="grid grid-cols-3 gap-4 mb-4">';
            html += '<div><p class="text-xs text-gray-500">Latest</p><p class="text-lg font-bold text-gray-800">$' + stats.latest.toFixed(5) + '</p></div>';
            html += '<div><p class="text-xs text-gray-500">Average</p><p class="text-lg font-bold text-gray-800">$' + stats.average.toFixed(5) + '</p></div>';
            html += '<div><p class="text-xs text-gray-500">12M Total</p><p class="text-lg font-bold text-indigo-600">$' + stats.total_12m.toFixed(2) + '</p></div>';
            html += '</div>';
            html += '<div class="mb-4">' + sparkline + '</div>';
            html += '<div class="space-y-1"><p class="text-xs font-semibold text-gray-600 mb-2">Recent Dividends:</p>' + recentDivs + '</div>';
            html += '</div>';
            
            return html;
        }

        function fetchDividends() {
            refreshBtn.disabled = true;
            refreshIcon.classList.add('animate-spin');
            refreshText.textContent = 'Loading...';
            hideAlerts();

            fetch(API_URL + '/api/dividends')
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    var contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('Server returned non-JSON response');
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log('API Response:', data);
                    return fetch(API_URL + '/api/dividends/history')
                        .then(function(histResponse) {
                            return histResponse.json();
                        })
                        .then(function(historyJson) {
                            if (historyJson.success) {
                                historyData = historyJson.data;
                                console.log('History data:', historyData);
                                renderHistoryCharts();
                            }
                            if (data.success && data.data && data.data.length > 0) {
                                renderTable(data.data);
                                updateTime.textContent = new Date().toLocaleString();
                                lastUpdate.classList.remove('hidden');
                                apiStatus.textContent = '‚úì Connected';
                                apiStatus.className = 'ml-2 text-green-600 font-semibold';
                            } else {
                                noDataAlert.classList.remove('hidden');
                                renderEmptyTable();
                            }
                        });
                })
                .catch(function(error) {
                    showError('Cannot connect to API server at ' + API_URL + '. Error: ' + error.message);
                    apiStatus.textContent = '‚úó Disconnected';
                    apiStatus.className = 'ml-2 text-red-600 font-semibold';
                    console.error('Fetch error:', error);
                    renderEmptyTable();
                })
                .finally(function() {
                    refreshBtn.disabled = false;
                    refreshIcon.classList.remove('animate-spin');
                    refreshText.textContent = 'Refresh Data';
                });
        }

        function triggerScrape() {
            scrapeBtn.disabled = true;
            scrapeIcon.classList.add('animate-spin');
            scrapeText.textContent = 'Scraping...';
            hideAlerts();

            fetch(API_URL + '/api/trigger-scrape', { method: 'POST' })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        showSuccess('Scrape completed and history updated! Refreshing data...');
                        setTimeout(function() { fetchDividends(); }, 1000);
                    } else {
                        showError(data.message || 'Scrape failed');
                    }
                })
                .catch(function(error) {
                    showError('Failed to trigger scrape. Make sure the Flask server is running.');
                    console.error('Scrape error:', error);
                })
                .finally(function() {
                    scrapeBtn.disabled = false;
                    scrapeIcon.classList.remove('animate-spin');
                    scrapeText.textContent = 'Run Scraper';
                });
        }

        function renderTable(dividends) {
            console.log('Rendering table with dividends:', dividends);
            
            var rows = dividends.map(function(div) {
                var ticker = div.ticker;
                var history = historyData[ticker] ? historyData[ticker].dividends : [];
                var stats = historyData[ticker] ? historyData[ticker].statistics : null;
                
                var sparkline = createSparkline(history.slice(0, 12), 100, 30);
                var total12m = stats ? '$' + stats.total_12m.toFixed(2) : 'N/A';
                
                var freqClass = div.frequency === 'Weekly' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
                var amountClass = div.amount === 'N/A' ? 'text-gray-400' : 'text-green-600';
                var dateClass = div.ex_date === 'N/A' ? 'text-gray-400' : 'text-gray-600';
                var statusClass = div.status === 'Success' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';

                return '<tr class="hover:bg-gray-50 transition-colors">' +
                       '<td class="px-6 py-4 font-bold text-indigo-600">' + div.ticker + '</td>' +
                       '<td class="px-6 py-4 text-gray-800 text-sm">' + div.name + '</td>' +
                       '<td class="px-6 py-4"><span class="px-3 py-1 rounded-full text-sm font-medium ' + freqClass + '">' + div.frequency + '</span></td>' +
                       '<td class="px-6 py-4 font-semibold ' + amountClass + '">' + div.amount + '</td>' +
                       '<td class="px-6 py-4">' + sparkline + '</td>' +
                       '<td class="px-6 py-4 ' + dateClass + ' text-sm">' + div.ex_date + '</td>' +
                       '<td class="px-6 py-4 font-semibold text-indigo-600">' + total12m + '</td>' +
                       '<td class="px-6 py-4"><span class="px-3 py-1 rounded-full text-xs font-medium ' + statusClass + '">' + div.status + '</span></td>' +
                       '</tr>';
            }).join('');
            
            tableBody.innerHTML = rows;
        }

        function renderHistoryCharts() {
            var chartsList = [];
            
            for (var ticker in historyData) {
                var data = historyData[ticker];
                if (data.statistics) {
                    chartsList.push(createDetailedChart(ticker, data.dividends, data.statistics));
                }
            }
            
            historyCharts.innerHTML = chartsList.length > 0 ? chartsList.join('') : '<p class="text-gray-500 col-span-2 text-center">No historical data available</p>';
        }

        function renderEmptyTable() {
            tableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500">' +
                '<div class="text-6xl mb-4">üíµ</div>' +
                '<p>No dividend data available</p>' +
                '<p class="text-sm mt-2">Click "Run Scraper" to fetch the latest declarations</p>' +
                '</td></tr>';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorAlert.classList.remove('hidden');
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successAlert.classList.remove('hidden');
            setTimeout(function() { successAlert.classList.add('hidden'); }, 5000);
        }

        function hideAlerts() {
            errorAlert.classList.add('hidden');
            noDataAlert.classList.add('hidden');
            successAlert.classList.add('hidden');
        }

        refreshBtn.addEventListener('click', fetchDividends);
        scrapeBtn.addEventListener('click', triggerScrape);

        fetchDividends();
    </script>
</body>
</html>